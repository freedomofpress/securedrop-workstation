---
name: ci

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      git_ref:
        required: true
        type: string
      qubes_ver:
        required: true
        type: string
      cancel:
        required: false
        type: boolean
      extra_params:  # KEY1=value1 KEY2=value2
        required: false
        type: string

# NOTE Concurrency serves two purposes:
#   1. When starting a new OpenQA job
#   2. When cancelling entirely: when trigger conditions no longer met, the
#      calling workflow is the best vantage point to cancel the workflow, so it
#      triggers a new workflow, except with 'cancel=true' as input. This results
#      in a no-op, but importantly, the previous OpenQA job is cancelled since
#      through concurrency there can only be one
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ inputs.environment }}-${{ inputs.qubes_ver }}
  cancel-in-progress: true

jobs:
  openqa-cancel:
    if: ${{ inputs.cancel }}  # Concurrency does the actual cancellation
    runs-on: ubuntu-latest
    steps:
      - name: Cancel OpenQA job # zizmor: ignore[template-injection]
        run: |
          echo "Canceling previous OpenQA job for Qubes ${{ inputs.qubes_ver }}"
  openqa:
    runs-on: ubuntu-latest
    if: ${{ ! inputs.cancel }}  # Concurrency does the actual cancellation
    env:
      OPENQA_HOST: "https://openqa.qubes-os.org/"
      OPENQA_KEY: ${{ secrets.OPENQA_KEY }}
      OPENQA_SECRET: ${{ secrets.OPENQA_SECRET }}
      GIT_REF: ${{ inputs.git_ref }}
      GH_TOKEN: ${{ github.token }}
      SECUREDROP_ENV: ${{ inputs.environment }}
      # The branch to clone on the FPF-managed remote OpenQA repo:
      # https://github.com/freedomofpress/openqa-tests-qubesos
      SECUREDROP_OPENQA_REPO_BRANCH: "main"
      # The URL to clone the remote OpenQA repo from (useful for forks):
      SECUREDROP_OPENQA_REPO_URL: "https://github.com/freedomofpress/openqa-tests-qubesos"
      QUBES_VER: ${{ inputs.qubes_ver }}
      EXTRA_PARAMS: ${{ inputs.extra_params }}
    container:
      image: debian:trixie
    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false
      - name: Install dependencies
        run: |
          apt-get update
          apt-get install --yes openqa-client jq curl
      - name: Start openQA jobs
        run: |
          echo "Queuing openQA jobs for commit ${GIT_REF}"
          openqa-cli api \
            --host "$OPENQA_HOST" \
            --apikey "$OPENQA_KEY" \
            --apisecret "$OPENQA_SECRET" \
            isos -X post \
            VERSION=${QUBES_VER} \
            BUILD=$(date +%Y%m%d%H%M)-${QUBES_VER} \
            DISTRI=qubesos ARCH=x86_64 \
            GIT_REF="$GIT_REF" \
            SECUREDROP_ENV="$SECUREDROP_ENV" \
            XRES=1920 YRES=1080 \
            FLAVOR=securedrop \
            CASEDIR="${SECUREDROP_OPENQA_REPO_URL}#${SECUREDROP_OPENQA_REPO_BRANCH}" \
            MAX_JOB_TIME=10800 \
            $EXTRA_PARAMS | tee openqa.json

          for id in $(jq -r '.ids[]' openqa.json); do

            # Obtain mapping (test_id, test_name)
            openqa-cli api \
              --host "$OPENQA_HOST" \
              --apikey "$OPENQA_KEY" \
              --apisecret "$OPENQA_SECRET" \
              -X GET "jobs/${id}" | jq -r ".job.settings.TEST" >  "${id}_name.txt"
            read TEST_NAME < "${id}_name.txt"

            # Make OpenQA links visible by creating Github check for each
            curl --fail -L -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN"\
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository }}/commits/$GIT_REF/statuses \
            -d "{\"state\": \"pending\", \"target_url\": \"${OPENQA_HOST}tests/${id}\", \"context\": \"OpenQA / ${QUBES_VER} / $TEST_NAME\"}"

          done
      - name: Wait for openQA
        run: |
          openqa-cli monitor \
            --host "$OPENQA_HOST" \
            --apikey "$OPENQA_KEY" \
            --apisecret "$OPENQA_SECRET" \
            $(jq -r '.ids[]' openqa.json) || :
      - name: Get result
        run: |
          workflow_exit_status=0

          for id in $(jq -r '.ids[]' openqa.json); do
            read TEST_NAME < "${id}_name.txt"

            # Obtain mapping (test_id, test_name)
            openqa_result=`openqa-cli api \
              --host "$OPENQA_HOST" \
              --apikey "$OPENQA_KEY" \
              --apisecret "$OPENQA_SECRET" \
              -X GET "jobs/${id}" | jq -r ".job.result"`

            # Apply result mapping: OpenQA -> GitHub (OpenQA statuses from https://open.qa/docs/#_jobs)
            case $openqa_result in
                "passed")
                    github_state="success"
                    ;;
                "failed"|"done"|"softfailed"|"obsoleted"|"parallel_failed"|"parallel_restarted")
                    workflow_exit_status=1
                    github_state="failure"
                    ;;
                "skipped"|"incomplete"|"cancelled"|"user_cancelled"|"user_restarted"|"timeout_exceeded")
                    workflow_exit_status=1
                    github_state="error"
                    ;;
                "none"|"scheduled"|"setup"|"running"|"uploading")
                    continue
                    ;;
                *)
                    echo "Unknown test status: $openqa_result"
                    workflow_exit_status=1
                    github_state="error"
                    ;;
            esac
            curl --fail -L -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN"\
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository }}/commits/$GIT_REF/statuses \
            -d "{\"state\": \"$github_state\", \"target_url\": \"${OPENQA_HOST}tests/${id}\", \"context\": \"OpenQA / ${QUBES_VER} / $TEST_NAME\"}"

          done
          exit $workflow_exit_status

      - name: Cancel openQA test (if needed)
        if: cancelled()
        run: |
          # Cancel all the jobs we queued in a best-effort manner
          for id in $(jq -r '.ids[]' openqa.json); do
            openqa-cli api \
              --host "$OPENQA_HOST" \
              --apikey "$OPENQA_KEY" \
              --apisecret "$OPENQA_SECRET" \
              -X POST "jobs/${id}/cancel" ||:

            read TEST_NAME < "${id}_name.txt"
            curl --fail -L -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN"\
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository }}/commits/$GIT_REF/statuses \
            -d "{\"state\": \"error\", \"target_url\": \"${OPENQA_HOST}tests/${id}\", \"context\": \"OpenQA / ${QUBES_VER} / $TEST_NAME\"}" ||:
          done
