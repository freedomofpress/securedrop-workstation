---
name: OpenQA
run-name: "[OpenQA] ${{ github.event.action == 'synchronize' && 'synchronize' || github.event.label.name }}"

on:
  pull_request:
    types:
      - labeled  # Trigger immediately when label added
      - synchronize

jobs:
  check:
    name: 'Check OpenQA triggers'
    runs-on: ubuntu-latest
    outputs:
      qubes-versions: ${{ steps.find_labels.outputs.qubes-versions }}
    steps:
      - name: Find all openqa-pending labels on this PR  # zizmor: ignore[template-injection]
        id: find_labels
        uses: actions/github-script@v8
        with:
          script: |
            const labels = context.payload.pull_request.labels;

            // Find all openqa-pending-* labels
            const openqaLabels = labels.filter(label =>
              label.name && label.name.match(/^openqa-pending-[0-9]+\.[0-9]+$/)
            );

            if (openqaLabels.length === 0) {
              console.log('No valid openqa-pending-* labels found');
              return;
            }

            // Extract Qubes versions
            const qubesVersions = openqaLabels.map(label =>
              label.name.replace('openqa-pending-', '')
            );

            console.log(`Found openqa-pending labels for versions: ${qubesVersions.join(', ')}`);
            core.setOutput('qubes-versions', JSON.stringify(qubesVersions));

  # Runs OpenQA job for each Qubes version found in labels
  openqa:
    needs: [check]
    if: ${{ needs.check.outputs.qubes-versions != '' }}
    strategy:
      matrix:
        qubes_version: ${{ fromJSON(needs.check.outputs.qubes-versions) }}
    uses: ./.github/workflows/openqa.yml
    secrets: inherit
    with:
      environment: "dev"
      git_ref: ${{ github.event.pull_request.head.sha }}
      qubes_ver: ${{ matrix.qubes_version }}
