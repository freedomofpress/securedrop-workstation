#!/usr/bin/python3
"""Install locally-built RPMs for SecureDrop Workstation dev environment."""
import subprocess
import sys
from pathlib import Path

EXPECTED_PACKAGES = {
    "securedrop-workstation-dom0-config",
    "securedrop-admin-dom0-config",
}

RPM_DIR = Path.home() / "securedrop-workstation" / "rpm-build" / "RPMS"


def fedora_version():
    """Return the Fedora version of the running system (e.g. '37', '41')."""
    return subprocess.check_output(
        ["rpm", "--eval", "%{fedora}"], text=True
    ).strip()


def discover_rpms():
    """Map package name -> file path for each built RPM matching EXPECTED_PACKAGES.

    Prefers RPMs matching the running Fedora version; falls back to any RPM
    (for CI environments that rename build artifacts).
    """
    fc = fedora_version()

    # First pass: match this Fedora version exactly
    rpms = _collect_rpms(RPM_DIR.rglob(f"*fc{fc}.noarch.rpm"))
    if rpms.keys() >= EXPECTED_PACKAGES:
        return rpms

    # Fallback: try any .rpm in the build directory
    print(f"No exact match for fc{fc}, trying any rpm in build directory")
    rpms = _collect_rpms(RPM_DIR.rglob("*.rpm"))

    missing = EXPECTED_PACKAGES - rpms.keys()
    if missing:
        print(f"Missing RPMs for: {', '.join(sorted(missing))}", file=sys.stderr)
        sys.exit(1)
    return rpms


def _collect_rpms(rpm_files):
    """Query each RPM file for its package name, return those in EXPECTED_PACKAGES."""
    rpms = {}
    for rpm_file in rpm_files:
        name = subprocess.check_output(
            ["rpm", "-qp", "--queryformat", "%{NAME}", str(rpm_file)],
            stderr=subprocess.DEVNULL,
        ).decode()
        if name in EXPECTED_PACKAGES:
            rpms[name] = rpm_file
    return rpms


def is_installed(package_name):
    return subprocess.run(["rpm", "-q", package_name], capture_output=True).returncode == 0


def install_rpms(rpms):
    subprocess.check_call(["sudo", "dnf", "clean", "all"])
    for name, path in sorted(rpms.items()):
        action = "reinstall" if is_installed(name) else "install"
        print(f">> dnf {action} {path.name}")
        subprocess.check_call(["sudo", "dnf", action, "-y", str(path)])


def main():
    rpms = discover_rpms()
    if len(rpms) != 2:
        raise RuntimeError("failed to find the expected 2 RPMs")
    install_rpms(rpms)


if __name__ == "__main__":
    main()
